name: Setup Windows RDP with Pinggy

on:
  workflow_dispatch:

jobs:
  setup-rdp:
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Create a new user
        run: |
          $username = "root"
          $password = "MyP@ssw0rd123"
          net user $username $password /add
          net localgroup administrators $username /add

      - name: Enable Remote Desktop
        run: |
          Set-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server" -Name "fDenyTSConnections" -Value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"

      - name: Start Pinggy SSH with RDP port forwarding
        run: |
          Invoke-WebRequest -Uri "https://the.earth.li/~sgtatham/putty/latest/w64/plink.exe" -OutFile "C:\plink.exe"
          C:\plink.exe -ssh t5w9T4lcjRY+tcp@free.pinggy.io -P 443 -pw t5w9T4lcjRY -R 3389:localhost:3389 -N -v -hostkey "ssh-rsa 4096 SHA256:nFd5rfJMGuZXvfeRzJ/BtT3TfksAxTWMajcrHRcI7AM"
